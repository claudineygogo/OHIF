# Scoring Server (App)

## Overview
The `app.py` script is the backend server for the Segmentation Scorer mode. It is a lightweight **Flask** application that performs mathematical grading of user segmentations against a "Gold Standard" or Reference.

## How It Works

The OHIF Viewer (frontend) sends the user's segmentation data to this server. The server calculates a similarity score (Dice Coefficient) and returns it.

### 1. Endpoint: `/grade_submission`
- **Method**: POST
- **Input JSON**:
  ```json
  {
      "non_zero_indices": [102, 103, 5002...],
      "origin_slice_index": 0,
      "patient_id": "Lung_Patient_001",
      "structure_name": "Tumor"
  }
  ```
- **Process**:
    1. **Locate Reference**: It looks for a JSON file at `References/{patient_id}/{structure_name}.json`.
    2. **Reconstruction**: It takes the sparse indices (list of numbers) from both the User and the Reference and reconstructs them into full 3D numpy boolean arrays (using `scorer.py` logic).
    3. **Comparison**: It calculates the **Dice Similarity Coefficient (DSC)**:
       $$ DSC = \frac{2 \times |X \cap Y|}{|X| + |Y|} $$
       (Where X is the reference volume and Y is the user volume).
    4. **Response**: Returns the score (0.0 to 1.0) and the reference indices (so the frontend can visualize the ground truth overlay).

### 2. Reference Management
The server relies on the `References` folder. This folder must act as a database of "Correct Answers". These files are generated by the `RTSTRUCT_to_SEG_and_JSON.py` tool.

## Usage

**Running the Server:**
```bash
python app.py
```
- Runs on **Port 5002** (default) to avoid conflicts with other services.
- Host: `0.0.0.0` (accessible from container/network).

## Data Involved

- **Input (Runtime)**: JSON payload from the web browser.
- **Storage**: Reads JSON files from the local `References/` subdirectory.
- **Output**: JSON response containing the calculated grade.

## Helper Modules
- **`scorer.py`**: Contains the heavy lifting for 3D array reconstruction and math. It handles the conversion from "Flat Indices" back to (Z, Y, X) coordinates to ensure valid volumetric overlap calculation.
